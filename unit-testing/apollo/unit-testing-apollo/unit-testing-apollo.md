---
title: Unit Testing Component using Apollo
---

Unit testing an app which has a DOM is always a difficult process. You
can be familiar with how a certain technology should be stubbed but to
go ahead and do so is unique to that specific technology.

UI related frameworks tend to change quickly. In addition, there are
many different frameworks, which results in a multitude of potential
testing frameworks.

Until recently (pre v1.1.0), using Apollo in an Angular App, was a very
cumbersome ordeal. In particular because there was no testing module.
You would have to spin it up themselves. However, now that we are
dealing with v1.1.0, there is an official testing suite set up.

 Re-visiting Component using Apollo 
-----------------------------------

First let's look at your standard Angular component generated by the
Angular CLI.

    import { Component, OnInit } from '@angular/core';

    @Component({
      selector: 'ill-color-picker',
      templateUrl: './ill-color-picker.component.html',
      styleUrls: ['./ill-color-picker.component.scss']
    })
    export class IllColorPickerComponent implements OnInit {

      constructor() { }

      ngOnInit() {
      }

    }

 Integrate Apollo with Component 
--------------------------------


    + import { Apollo } from 'apollo-angular';

    +  ngOnInit() {
    +    this.apollo
    +      .query({
    +        query: gql`
    +          colors
    +        `,
    +      })
    +      .subscribe((initialData: any) => {
    +      });
    +  }

 Unit testing Apollo 
--------------------

First let's analyze what your generic Angular CLI generated spec will
look like:

    import { async, ComponentFixture, TestBed } from '@angular/core/testing';

    import { IllColorPickerComponent } from './ill-color-picker.component';

    describe('IllColorPickerComponent', () => {
      let component: IllColorPickerComponent;
      let fixture: ComponentFixture<IllColorPickerComponent>;

      beforeEach(async(() => {
        TestBed.configureTestingModule({
          declarations: [ IllColorPickerComponent ]
        })
        .compileComponents();
      }));

      beforeEach(() => {
        fixture = TestBed.createComponent(IllColorPickerComponent);
        component = fixture.componentInstance;
        fixture.detectChanges();
      });

      it('should create', () => {
        expect(component).toBeTruthy();
      });
    });

 Adding Apollo Testing Module 
-----------------------------

    import {ApolloTestingModule} from 'apollo-angular/testing';
    //..
    + ApolloTestingModule,
    //..

The Apollo Testing Module will hijack the actual Apollo Module, and make
it so that there is no error in particular with regards to creating an
Apollo client.

 Hijacking the Component's GraphQL Request 
------------------------------------------

After we have imported our ApolloTestingModule within the app, we now
need to make it so that our GraphQL requests go straight to our fake
backend request. If we do not, of course, the colors GraphQL request
will attempt to go the default apollo link, making unit testing
dependent on our GraphQL server.

###  Initializing the ApolloTestingBackend 

    + import {ApolloTestingBackend} from 'apollo-angular/testing/backend';

    + const mock = new ApolloTestingBackend();

ApolloTestingBackend works by keeping a list of all open operations. As
operations come in, they're added to the list. Users can assert that
specific operations were made and then flush them. In the end, a
verify() method asserts that no unexpected operations were made. [^1]

###  Initializing the Apollo Link 

    + import {ApolloLink} from 'apollo-link';

    + const link = new ApolloLink(op => mock.handle(op));

An Apollo Link as the documentation mentions, is a function that takes
an operation and returns an observable. We are simply trying to repeat
the process. In particular for the execute function.

###  Initializing the Operation 

    + const buildOperationForLink = (
    +    document: DocumentNode,
    +    variables: any,
    +  ) => {
    +    return {
    +      query: document,
    +      variables,
    +      operationName: getOperationName(document) || undefined,
    +      context: {},
    +    };
    +  };

    + const operation = buildOperationForLink(query, {});

###  Running the Execute Function 

    + import {ApolloLink, execute} from 'apollo-link';

    + execute(link, operation as any).subscribe(result => (response = result));

The execute function will take link which is a mock link, as well as use
our operation(i.e. GraphQL query) and return an observable that we can
now use to get back our result.

[^1]: This particular description can be found in:
    https://github.com/apollographql/apollo-angular/blob/master/packages/apollo-angular/testing/src/backend.ts
